<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drop Punts</title>
  <style>
    :root{
      --bg:#0b0d12; --card:#121725; --muted:#9aa3b2; --text:#e9eef7; --line:#263049;
      --good:#37d67a; --bad:##C72F2F; --warn:#f7c948;
      --accent:#7aa2ff;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
    }
    :root { color-scheme: dark; }
    [data-theme="light"] { color-scheme: light; }
    select, option {
      background: var(--card);
      color: var(--text);
    }

    [data-theme="light"]{
      --bg:#f4f6fb; --card:#ffffff; --muted:#5b677a; --text:#0f172a; --line:#e3e8f2;
      --shadow: 0 8px 22px rgba(15,23,42,.10);
      --accent:#2f5bff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg); color:var(--text);
    }
    a{color:var(--accent)}
    .wrap{max-width:1100px; margin:0 auto; padding:20px}
    header{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:16px;
    }
    .title{display:flex; flex-direction:column; gap:6px}
    h1{margin:0; font-size:22px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px}
    .row{display:grid; gap:12px}
    .grid2{grid-template-columns: 1.2fr .8fr}
    .grid3{grid-template-columns: repeat(3, 1fr)}
    @media (max-width: 900px){
      .grid2, .grid3{grid-template-columns:1fr}
    }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:14px;
    }
    .card h2{margin:0 0 10px; font-size:16px}
    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
    @media (max-width: 900px){ .kpis{grid-template-columns: repeat(2, 1fr)} }
    .kpi{
      border:1px solid var(--line); border-radius:14px; padding:10px; background:rgba(255,255,255,.02)
    }
    [data-theme="light"] .kpi{background:#fafbff}
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .value{font-size:18px; margin-top:4px; font-weight:700}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button, select, input{
      background:transparent; color:var(--text);
      border:1px solid var(--line); border-radius:12px;
      padding:9px 10px; font-size:13px;
    }
    button{cursor:pointer}
    button:hover{border-color:var(--accent)}
    .hint{color:var(--muted); font-size:12px}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid var(--line)}
    thead th{
      text-align:left; font-size:12px; color:var(--muted); background:rgba(255,255,255,.02);
      padding:10px; border-bottom:1px solid var(--line); position:sticky; top:0;
    }
    [data-theme="light"] thead th{background:#f5f7ff}
    tbody td{padding:10px; border-bottom:1px solid var(--line); font-size:13px}
    tbody tr:last-child td{border-bottom:none}
    .mono{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1;}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 8px; border-radius:999px; border:1px solid var(--line);
      font-size:12px; color:var(--muted);
    }
    .right{text-align:right}
    .split{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .feed{display:flex; flex-direction:column; gap:8px}
    .feedItem{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      padding:10px; border:1px solid var(--line); border-radius:14px;
      background:rgba(255,255,255,.02);
    }
    [data-theme="light"] .feedItem{background:#fafbff}
    .feedLeft{display:flex; flex-direction:column; gap:3px}
    .feedTop{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .small{font-size:12px; color:var(--muted)}
    .statusW{color:var(--good); font-weight:700}
    .statusL{color:var(--bad); font-weight:700}
    .statusP{color:var(--warn); font-weight:700}
    .statusV{color:var(--muted); font-weight:700}
    .err{padding:12px; border-radius:14px; border:1px solid rgba(255,92,92,.4); background: rgba(255,92,92,.08)}
    .loading{opacity:.8}
    .footer{margin-top:14px; color:var(--muted); font-size:12px}
    .scrollX{overflow:auto}

    /* clickable names */
    .linkBtn{
      background:transparent; border:none; padding:0; margin:0;
      color:var(--accent); cursor:pointer; font:inherit; text-decoration:underline;
    }

    /* modal */
    .modalBg{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:18px; z-index:50;
    }
    .modal{
      width:min(880px, 100%); max-height:85vh; overflow:auto;
      background:var(--card); border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow);
      padding:14px;
    }
    .modalHeader{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .modalTitle{display:flex; flex-direction:column; gap:4px}
    .modalTitle h3{margin:0; font-size:18px}
    canvas{width:100%; height:160px; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.02)}
    [data-theme="light"] canvas{background:#fafbff}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1 id="clubTitle">Drop Punts</h1>
      <div class="sub" id="clubSub">Loading‚Ä¶</div>
    </div>
    <div class="toolbar">
      <span class="pill" id="lastUpdated">Last updated: ‚Äî</span>

      <select id="sortBy">
        <option value="profit">Sort: Profit</option>
        <option value="roi">Sort: ROI</option>
        <option value="winrate">Sort: Win %</option>
        <option value="staked">Sort: Total Staked</option>
      </select>

      <select id="roundSelect"></select>

      <button id="themeBtn" title="Toggle dark/light">Toggle theme</button>
      <button id="refreshBtn" title="Reload data">Refresh</button>
    </div>
  </header>

  <div id="errorBox" class="err" style="display:none"></div>

  <div class="row">
    <div class="card">
      <h2>Season Overview</h2>
      <div class="kpis">
        <div class="kpi">
          <div class="label">Club Profit</div>
          <div class="value mono" id="kpiProfit">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="label">Club ROI</div>
          <div class="value mono" id="kpiROI">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="label">Total Staked</div>
          <div class="value mono" id="kpiStaked">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="label">Open (Pending) Stake</div>
          <div class="value mono" id="kpiPending">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="row grid3">
      <div class="card">
        <h2>Hall of Fame / Shame</h2>
        <div class="small" id="hofBody">Loading‚Ä¶</div>
      </div>
      <div class="card">
        <h2>Streaks</h2>
        <div class="small" id="streakBody">Loading‚Ä¶</div>
      </div>
      <div class="card">
        <h2>Group Multi Tracker</h2>
        <div class="small" id="groupMultiBody">Loading‚Ä¶</div>
      </div>
      <div class="card">
        <h2>Selected Round Callouts</h2>
        <div class="small" id="roundCallouts">Pick a round to see winner/wooden spoon.</div>
      </div>
    </div>

    <div class="row grid2">
      <div class="card">
        <div class="split">
          <h2 style="margin:0">Leaderboard</h2>
          <div class="hint">Click a name for more stats.</div>
        </div>
        <div class="scrollX">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Name</th>
                <th class="right">Profit</th>
                <th class="right">ROI</th>
                <th class="right">Win %</th>
                <th class="right">Bets</th>
                <th class="right">Staked</th>
                <th class="right">Returned</th>
              </tr>
            </thead>
            <tbody id="leaderBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Club Bank</h2>
        <div class="kpis" style="grid-template-columns:1fr 1fr; gap:10px">
          <div class="kpi">
            <div class="label">Contributions In</div>
            <div class="value mono" id="bankIn">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Stakes Out</div>
            <div class="value mono" id="bankOut">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Returns In</div>
            <div class="value mono" id="bankReturns">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Current Balance</div>
            <div class="value mono" id="bankBal">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row grid2">
      <div class="card">
        <h2>Round View</h2>

        <div class="toolbar" style="margin:8px 0 10px">
          <select id="personFilter"></select>
          <select id="typeFilter">
            <option value="ALL">BetType: All</option>
            <option value="Normal">Normal</option>
            <option value="Future">Future</option>
            <option value="Multi">Multi</option>
            <option value="Promo">Promo</option>
          </select>
          <select id="resultFilter">
            <option value="ALL">Result: All</option>
            <option value="W">W</option>
            <option value="L">L</option>
            <option value="V">V</option>
            <option value="P">P</option>
          </select>
          <input id="searchBox" placeholder="Search match/market/notes‚Ä¶" style="min-width:220px; flex:1" />
        </div>

        <div class="hint" id="roundHint">Pick a round (top right) to see bets and results.</div>
        <div class="scrollX" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Match</th>
                <th>Market</th>
                <th class="right">Odds</th>
                <th class="right">Stake</th>
                <th class="right">Result</th>
                <th class="right">Profit</th>
              </tr>
            </thead>
            <tbody id="roundBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Open Futures</h2>
        <div class="scrollX" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Match/Market</th>
                <th class="right">Odds</th>
                <th class="right">Stake</th>
                <th class="right">Potential Profit</th>
              </tr>
            </thead>
            <tbody id="futuresBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Recent Bets</h2>
      <div class="feed" id="recentFeed"></div>
    </div>
  </div>

  <div class="footer"></div>
</div>

<!-- Profile Modal -->
<div class="modalBg" id="modalBg">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">
        <h3 id="profileTitle">Player</h3>
        <div class="small" id="profileSub">‚Äî</div>
      </div>
      <div class="toolbar">
        <button id="closeModal">Close</button>
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="kpis" style="grid-template-columns:repeat(4,1fr)">
      <div class="kpi">
        <div class="label">Profit</div>
        <div class="value mono" id="pProfit">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="label">ROI</div>
        <div class="value mono" id="pROI">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="label">Win %</div>
        <div class="value mono" id="pWin">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="label">Bets</div>
        <div class="value mono" id="pBets">‚Äî</div>
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="small" style="margin-bottom:8px">Cumulative profit over time (settled bets only).</div>
    <canvas id="profitChart" width="900" height="260"></canvas>

    <div style="height:12px"></div>
    <div class="scrollX">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Round</th>
            <th>Match</th>
            <th>Market</th>
            <th class="right">Odds</th>
            <th class="right">Stake</th>
            <th class="right">Result</th>
            <th class="right">Profit</th>
          </tr>
        </thead>
        <tbody id="profileBetsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // === Your published CSV links ===
  const CSV = {
    members: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOaANwkoUdpnE5JbIgqQpePAgswv04vyLNsCeWJhoTuwlZE6BZth7iexve2L_4RpR-q7rOFUHZcuwh/pub?gid=0&single=true&output=csv",
    contributions: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOaANwkoUdpnE5JbIgqQpePAgswv04vyLNsCeWJhoTuwlZE6BZth7iexve2L_4RpR-q7rOFUHZcuwh/pub?gid=1440517173&single=true&output=csv",
    bets: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOaANwkoUdpnE5JbIgqQpePAgswv04vyLNsCeWJhoTuwlZE6BZth7iexve2L_4RpR-q7rOFUHZcuwh/pub?gid=711038859&single=true&output=csv",
    config: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOaANwkoUdpnE5JbIgqQpePAgswv04vyLNsCeWJhoTuwlZE6BZth7iexve2L_4RpR-q7rOFUHZcuwh/pub?gid=448769165&single=true&output=csv",
    grouplegs: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOaANwkoUdpnE5JbIgqQpePAgswv04vyLNsCeWJhoTuwlZE6BZth7iexve2L_4RpR-q7rOFUHZcuwh/pub?gid=262930476&single=true&output=csv",
    };

  const $ = (id) => document.getElementById(id);

  function setError(msg){
    const box = $("errorBox");
    if(!msg){ box.style.display="none"; box.textContent=""; return; }
    box.style.display="block";
    box.innerHTML = msg;
  }

  function parseCSV(text){
    const rows = [];
    let i=0, field="", row=[], inQuotes=false;
    while(i < text.length){
      const c = text[i];
      if(inQuotes){
        if(c === '"' && text[i+1] === '"'){ field+='"'; i+=2; continue; }
        if(c === '"'){ inQuotes=false; i++; continue; }
        field+=c; i++; continue;
      } else {
        if(c === '"'){ inQuotes=true; i++; continue; }
        if(c === ','){ row.push(field); field=""; i++; continue; }
        if(c === '\n'){
          row.push(field); field="";
          if(row.length===1 && row[0]===""){ row=[]; i++; continue; }
          rows.push(row.map(x => x.replace(/\r/g,"")));
          row=[]; i++; continue;
        }
        field+=c; i++; continue;
      }
    }
    if(field.length || row.length){
      row.push(field.replace(/\r/g,""));
      rows.push(row);
    }
    const header = rows[0].map(h => (h||"").trim());
    const out = [];
    for(let r=1; r<rows.length; r++){
      const obj = {};
      for(let c=0; c<header.length; c++){
        obj[header[c]] = (rows[r][c] ?? "").trim();
      }
      const anyVal = Object.values(obj).some(v => v !== "");
      if(anyVal) out.push(obj);
    }
    return out;
  }

  function toNum(x){
    if(x===null || x===undefined) return 0;
    const s = String(x).replace(/[$, ]/g,"").trim();
    if(!s) return 0;
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function fmtMoney(n, currency="AUD"){
    const sign = n < 0 ? "-" : "";
    const abs = Math.abs(n);
    const prefix = (currency || "").toUpperCase() === "AUD" ? "$" : "";
    return sign + prefix + abs.toFixed(2);
  }

  function fmtPct(n){
    if(!Number.isFinite(n)) return "‚Äî";
    return (n*100).toFixed(1) + "%";
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
    }[m]));
  }

  function normalizeDate(s){
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  }

  function profitForBet(b){
    const stake = toNum(b.Stake);
    const ret = toNum(b.Return);
    const res = (b.Result||"").toUpperCase();
    if(res === "V") return 0;
    if(res === "P") return 0;
    return ret - stake;
  }

  function isSettled(res){
    res = (res||"").toUpperCase();
    return res==="W" || res==="L" || res==="V";
  }

  let STATE = {
    config: {},
    members: [],
    bets: [],
    contributions: [],
    currency: "AUD",
    startRound: 1,
    endRound: 24,
    leaderboard: [],
    groupLegs: [],
  };

  async function fetchCSV(url){
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error(`Failed to fetch: ${url}`);
    const t = await r.text();
    return parseCSV(t);
  }

  function readConfig(rows){
    const cfg = {};
    for(const r of rows){
      const k = (r.Key||"").trim();
      const v = (r.Value||"").trim();
      if(k) cfg[k] = v;
    }
    return cfg;
  }

  function activeMembers(members){
    return members
      .filter(m => String(m.Active||"").toUpperCase() !== "FALSE")
      .map(m => ({
        name: (m.Name||"").trim(),
        nickname: (m.Nickname||"").trim(),
        joinDate: (m.JoinDate||"").trim(),
        active: String(m.Active||"TRUE").toUpperCase() !== "FALSE"
      }))
      .filter(m => m.name);
  }

  function applyConfig(){
    const cfg = STATE.config;
    const clubName = cfg.ClubName || "Drop Punts";
    const season = cfg.Season || "AFL Season";
    STATE.currency = (cfg.Currency || "AUD").toUpperCase();
    STATE.startRound = Number(cfg.StartRound || 1);
    STATE.endRound = Number(cfg.EndRound || 24);

    $("clubTitle").textContent = `${clubName} ‚Äî ${season}`;
    $("clubSub").textContent = `Members: ${STATE.members.length} ¬∑ Currency: ${STATE.currency} ¬∑ Rounds: ${STATE.startRound}-${STATE.endRound}`;
  }

  function computeLeaderboard(){
    const names = STATE.members.map(m => m.name);
    const byName = new Map();
    for(const n of names){
      byName.set(n, {
        name: n,
        profit: 0,
        settledStake: 0,
        totalStake: 0,
        returned: 0,
        wins: 0,
        losses: 0,
        voids: 0,
        pendingStake: 0,
        bets: 0,
        settledBets: 0
      });
    }

    for(const b of STATE.bets){
      const name = (b.Name||"").trim();
      if(!byName.has(name)) continue;
      const row = byName.get(name);
      const stake = toNum(b.Stake);
      const ret = toNum(b.Return);
      const res = (b.Result||"").toUpperCase();

      row.bets += 1;
      row.totalStake += stake;

      if(res === "P"){
        row.pendingStake += stake;
        continue;
      }

      row.settledStake += stake;
      row.returned += ret;
      row.profit += profitForBet(b);
      row.settledBets += 1;

      if(res === "W") row.wins += 1;
      else if(res === "L") row.losses += 1;
      else if(res === "V") row.voids += 1;
    }

    const arr = Array.from(byName.values());
    for(const r of arr){
      const denom = r.settledStake;
      r.roi = denom > 0 ? (r.profit / denom) : 0;
      const wrDenom = r.wins + r.losses;
      r.winrate = wrDenom > 0 ? (r.wins / wrDenom) : 0;
    }
    return arr;
  }

  function computeClubTotals(leader){
    let clubProfit=0, clubSettledStake=0, clubTotalStake=0, clubReturned=0, clubPending=0;
    for(const r of leader){
      clubProfit += r.profit;
      clubSettledStake += r.settledStake;
      clubTotalStake += r.totalStake;
      clubReturned += r.returned;
      clubPending += r.pendingStake;
    }
    const clubROI = clubSettledStake > 0 ? (clubProfit/clubSettledStake) : 0;
    return {clubProfit, clubROI, clubSettledStake, clubTotalStake, clubReturned, clubPending};
  }

  function computeBank(){
    let inTotal = 0;
    for(const c of STATE.contributions){
      inTotal += toNum(c.Amount);
    }
    let stakes = 0, returns = 0;
    for(const b of STATE.bets){
      stakes += toNum(b.Stake);
      returns += toNum(b.Return);
    }
    const balance = inTotal - stakes + returns;
    return {inTotal, stakes, returns, balance};
  }

  function computeLastUpdated(){
    const dates = [];
    for(const b of STATE.bets){
      const d = normalizeDate(b.Date);
      if(d) dates.push(d.getTime());
    }
    for(const c of STATE.contributions){
      const d = normalizeDate(c.Date);
      if(d) dates.push(d.getTime());
    }
    if(!dates.length) return null;
    return new Date(Math.max(...dates));
  }

  function buildRoundOptions(){
    const sel = $("roundSelect");
    sel.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "ALL";
    optAll.textContent = "Round: All";
    sel.appendChild(optAll);

    for(let r = STATE.startRound; r <= STATE.endRound; r++){
      const o = document.createElement("option");
      o.value = String(r);
      o.textContent = "Round: " + r;
      sel.appendChild(o);
    }

    const roundsPresent = new Set(STATE.bets.map(b => Number(b.Round)).filter(x => Number.isFinite(x) && x>0));
    const maxR = roundsPresent.size ? Math.max(...roundsPresent) : null;
    if(maxR){ sel.value = String(maxR); }
  }

  function buildPersonFilter(){
    const sel = $("personFilter");
    sel.innerHTML = "";
    const a = document.createElement("option");
    a.value = "ALL";
    a.textContent = "Person: All";
    sel.appendChild(a);

    for(const m of STATE.members){
      const o = document.createElement("option");
      o.value = m.name;
      o.textContent = "Person: " + m.name;
      sel.appendChild(o);
    }
  }

  function renderOverview(totals){
    $("kpiProfit").textContent = fmtMoney(totals.clubProfit, STATE.currency);
    $("kpiProfit").className = "value mono " + (totals.clubProfit>0 ? "good" : totals.clubProfit<0 ? "bad" : "");
    $("kpiROI").textContent = fmtPct(totals.clubROI);
    $("kpiROI").className = "value mono " + (totals.clubROI>0 ? "good" : totals.clubROI<0 ? "bad" : "");
    $("kpiStaked").textContent = fmtMoney(totals.clubTotalStake, STATE.currency);
    $("kpiPending").textContent = fmtMoney(totals.clubPending, STATE.currency);
  }

  function renderBank(bank){
    $("bankIn").textContent = fmtMoney(bank.inTotal, STATE.currency);
    $("bankOut").textContent = fmtMoney(bank.stakes, STATE.currency);
    $("bankReturns").textContent = fmtMoney(bank.returns, STATE.currency);
    $("bankBal").textContent = fmtMoney(bank.balance, STATE.currency);
    $("bankBal").className = "value mono " + (bank.balance>0 ? "good" : bank.balance<0 ? "bad" : "");
  }

  function renderLeaderboard(leader){
    const sort = $("sortBy").value;
    leader.sort((a,b) => {
      if(sort==="roi") return b.roi - a.roi;
      if(sort==="winrate") return b.winrate - a.winrate;
      if(sort==="staked") return b.totalStake - a.totalStake;
      return b.profit - a.profit;
    });

    const tbody = $("leaderBody");
    tbody.innerHTML = "";
    leader.forEach((r, idx) => {
      const tr = document.createElement("tr");
      const profitCls = r.profit > 0 ? "good" : (r.profit < 0 ? "bad" : "");
      const roiCls = r.roi > 0 ? "good" : (r.roi < 0 ? "bad" : "");

      tr.innerHTML = `
        <td class="mono">${idx+1}</td>
        <td>
          <button class="linkBtn" data-player="${escapeHtml(r.name)}">${escapeHtml(r.name)}</button>
        </td>
        <td class="right mono ${profitCls}">${fmtMoney(r.profit, STATE.currency)}</td>
        <td class="right mono ${roiCls}">${fmtPct(r.roi)}</td>
        <td class="right mono">${fmtPct(r.winrate)}</td>
        <td class="right mono">${r.bets}</td>
        <td class="right mono">${fmtMoney(r.totalStake, STATE.currency)}</td>
        <td class="right mono">${fmtMoney(r.returned, STATE.currency)}</td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-player]").forEach(btn => {
      btn.addEventListener("click", () => openProfile(btn.getAttribute("data-player")));
    });
  }

  function renderFutures(){
    const futures = STATE.bets
      .filter(b => (b.BetType||"").trim()==="Future" && (b.Result||"").toUpperCase()==="P")
      .sort((a,b) => (normalizeDate(b.Date)?.getTime() ?? 0) - (normalizeDate(a.Date)?.getTime() ?? 0));

    const tb = $("futuresBody");
    tb.innerHTML = "";

    if(!futures.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="6" class="small">No open futures yet.</td>`;
      tb.appendChild(tr);
      return;
    }

    for(const b of futures){
      const stake = toNum(b.Stake);
      const odds = toNum(b.Odds);
      const potentialProfit = (odds>0 ? (stake*odds - stake) : 0);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(b.Date||"")}</td>
        <td><b>${escapeHtml(b.Name||"")}</b></td>
        <td>${escapeHtml((b.Match||"") + (b.Market?(" ‚Ä¢ "+b.Market):""))}</td>
        <td class="right mono">${odds ? odds.toFixed(2) : "‚Äî"}</td>
        <td class="right mono">${fmtMoney(stake, STATE.currency)}</td>
        <td class="right mono good">${fmtMoney(potentialProfit, STATE.currency)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function getFilters(){
    return {
      round: $("roundSelect").value,
      person: $("personFilter").value,
      betType: $("typeFilter").value,
      result: $("resultFilter").value,
      q: ($("searchBox").value || "").trim().toLowerCase(),
    };
  }

  function filterBets(rows){
    const f = getFilters();
    return rows.filter(b => {
      const r = (b.Result||"").toUpperCase();
      const t = (b.BetType||"Normal").trim();
      const name = (b.Name||"").trim();

      if(f.round !== "ALL" && String(b.Round||"").trim() !== f.round) return false;
      if(f.person !== "ALL" && name !== f.person) return false;
      if(f.betType !== "ALL" && t !== f.betType) return false;
      if(f.result !== "ALL" && r !== f.result) return false;

      if(f.q){
        const hay = `${b.Match||""} ${b.Market||""} ${b.Notes||""}`.toLowerCase();
        if(!hay.includes(f.q)) return false;
      }
      return true;
    });
  }

  function renderRoundView(){
    const f = getFilters();
    let rows = STATE.bets.slice();

    rows = filterBets(rows).sort((a,b) => (normalizeDate(b.Date)?.getTime() ?? 0) - (normalizeDate(a.Date)?.getTime() ?? 0));

    if(f.round !== "ALL"){
      $("roundHint").textContent = `Showing bets for Round ${f.round} (filters applied).`;
    } else {
      $("roundHint").textContent = ``;
    }

    const tb = $("roundBody");
    tb.innerHTML = "";

    if(!rows.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="small">No bets match these filters yet.</td>`;
      tb.appendChild(tr);
      renderRoundCallouts(); // still update callouts
      return;
    }

    for(const b of rows){
      const res = (b.Result||"").toUpperCase();
      const stake = toNum(b.Stake);
      const odds = toNum(b.Odds);
      const p = profitForBet(b);
      const pCls = p>0 ? "good" : p<0 ? "bad" : "";
      const resCls = res==="W" ? "statusW" : res==="L" ? "statusL" : res==="P" ? "statusP" : "statusV";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(b.Date||"")}</td>
        <td><b>${escapeHtml(b.Name||"")}</b></td>
        <td>${escapeHtml(b.Match||"")}</td>
        <td>${escapeHtml(b.Market||"")}</td>
        <td class="right mono">${odds ? odds.toFixed(2) : "‚Äî"}</td>
        <td class="right mono">${fmtMoney(stake, STATE.currency)}</td>
        <td class="right mono ${resCls}">${escapeHtml(res || "‚Äî")}</td>
        <td class="right mono ${pCls}">${res==="P" ? "‚Äî" : fmtMoney(p, STATE.currency)}</td>
      `;
      tb.appendChild(tr);
    }

    renderRoundCallouts();
  }

  function renderRecent(){
    // Recent respects filters EXCEPT round (so it stays "recent" even if you select a round)
    const f = getFilters();
    const temp = {...f, round:"ALL"};
    const rows = STATE.bets.slice()
      .filter(b => {
        // apply person/type/result/search only
        const r = (b.Result||"").toUpperCase();
        const t = (b.BetType||"Normal").trim();
        const name = (b.Name||"").trim();
        if(temp.person !== "ALL" && name !== temp.person) return false;
        if(temp.betType !== "ALL" && t !== temp.betType) return false;
        if(temp.result !== "ALL" && r !== temp.result) return false;
        if(temp.q){
          const hay = `${b.Match||""} ${b.Market||""} ${b.Notes||""}`.toLowerCase();
          if(!hay.includes(temp.q)) return false;
        }
        return true;
      })
      .sort((a,b) => (normalizeDate(b.Date)?.getTime() ?? 0) - (normalizeDate(a.Date)?.getTime() ?? 0))
      .slice(0, 15);

    const feed = $("recentFeed");
    feed.innerHTML = "";

    if(!rows.length){
      feed.innerHTML = `<div class="small">No bets logged yet (or none match your filters).</div>`;
      return;
    }

    for(const b of rows){
      const res = (b.Result||"").toUpperCase();
      const stake = toNum(b.Stake);
      const odds = toNum(b.Odds);
      const p = profitForBet(b);
      const pTxt = res==="P" ? "Pending" : (p>=0 ? `+${fmtMoney(p, STATE.currency)}` : `-${fmtMoney(Math.abs(p), STATE.currency)}`);
      const pCls = res==="P" ? "warn" : (p>0 ? "good" : p<0 ? "bad" : "");
      const resCls = res==="W" ? "statusW" : res==="L" ? "statusL" : res==="P" ? "statusP" : "statusV";

      const matchLine = `${escapeHtml(b.Match||"")} ${b.Market ? "‚Ä¢ "+escapeHtml(b.Market) : ""}`;

      const div = document.createElement("div");
      div.className = "feedItem";
      div.innerHTML = `
        <div class="feedLeft">
          <div class="feedTop">
            <b>${escapeHtml(b.Name||"")}</b>
            <span class="pill">${escapeHtml((b.BetType||"Normal") || "Normal")}</span>
            <span class="pill">R${escapeHtml(String(b.Round||""))}</span>
            <span class="pill ${resCls}">Result: ${escapeHtml(res||"‚Äî")}</span>
          </div>
          <div class="small">${escapeHtml(b.Date||"")} ‚Äî ${matchLine}</div>
          <div class="small">Odds <b class="mono">${odds ? odds.toFixed(2) : "‚Äî"}</b> ¬∑ Stake <b class="mono">${fmtMoney(stake, STATE.currency)}</b>${b.Notes ? " ¬∑ "+escapeHtml(b.Notes) : ""}</div>
        </div>
        <div class="mono ${pCls}" style="font-weight:800; white-space:nowrap">${pTxt}</div>
      `;
      feed.appendChild(div);
    }
  }

  function renderHallOfFame(){
    const settled = STATE.bets.filter(b => isSettled((b.Result||"").toUpperCase()));
    if(!settled.length){
      $("hofBody").innerHTML = "No settled bets yet.";
      return;
    }

    // biggest win / loss by profit per bet
    let best = null, worst = null, highestOddsWin = null;
    for(const b of settled){
      const res = (b.Result||"").toUpperCase();
      const p = profitForBet(b);
      const odds = toNum(b.Odds);

      if(best === null || p > best.p) best = {b, p};
      if(worst === null || p < worst.p) worst = {b, p};

      if(res === "W"){
        if(highestOddsWin === null || odds > highestOddsWin.odds){
          highestOddsWin = {b, odds, p};
        }
      }
    }

    const line = (label, item, extraClass="") => {
      if(!item) return `<div>${label}: ‚Äî</div>`;
      const b = item.b;
      return `
        <div>
          <b>${label}:</b>
          <span class="${extraClass} mono">${label.includes("Loss") ? fmtMoney(item.p, STATE.currency) : fmtMoney(item.p, STATE.currency)}</span>
          <span class="small">‚Äî ${escapeHtml(b.Name||"")} ¬∑ ${escapeHtml(b.Match||"")} ${b.Market?("‚Ä¢ "+escapeHtml(b.Market)):""} ¬∑ odds ${toNum(b.Odds).toFixed(2)} ¬∑ stake ${fmtMoney(toNum(b.Stake), STATE.currency)}</span>
        </div>
      `;
    };

    const bestCls = best?.p > 0 ? "good" : "";
    const worstCls = worst?.p < 0 ? "bad" : "";
    const highestLine = highestOddsWin ? `
      <div>
        <b>Highest Odds Win:</b>
        <span class="mono good">${toNum(highestOddsWin.b.Odds).toFixed(2)}</span>
        <span class="small">‚Äî ${escapeHtml(highestOddsWin.b.Name||"")} ¬∑ ${escapeHtml(highestOddsWin.b.Match||"")} ${highestOddsWin.b.Market?("‚Ä¢ "+escapeHtml(highestOddsWin.b.Market)):""} ¬∑ profit ${fmtMoney(highestOddsWin.p, STATE.currency)}</span>
      </div>
    ` : `<div><b>Highest Odds Win:</b> ‚Äî</div>`;

    $("hofBody").innerHTML = `
      ${line("Biggest Win", best, bestCls)}
      ${line("Biggest Loss", worst, worstCls)}
      ${highestLine}
      <div class="small" style="margin-top:8px">Tip: Tag multis as <b>BetType=Multi</b> so your worst multi becomes obvious üòÑ</div>
    `;
  }

  function computeStreaks(){
    // per member: current streak and best win/loss streak (W/L only)
    const out = [];
    for(const m of STATE.members){
      const bets = STATE.bets
        .filter(b => (b.Name||"").trim() === m.name)
        .filter(b => ["W","L"].includes((b.Result||"").toUpperCase()))
        .sort((a,b) => (normalizeDate(a.Date)?.getTime() ?? 0) - (normalizeDate(b.Date)?.getTime() ?? 0));

      let bestW=0, bestL=0;
      let curType=null, curLen=0;
      let tmpType=null, tmpLen=0;

      for(const b of bets){
        const r = (b.Result||"").toUpperCase();
        if(tmpType === r){
          tmpLen++;
        } else {
          tmpType = r;
          tmpLen = 1;
        }
        if(tmpType==="W") bestW = Math.max(bestW, tmpLen);
        if(tmpType==="L") bestL = Math.max(bestL, tmpLen);
      }

      if(bets.length){
        // current streak = last run
        const last = bets[bets.length-1];
        curType = (last.Result||"").toUpperCase();
        curLen = 1;
        for(let i=bets.length-2; i>=0; i--){
          const r = (bets[i].Result||"").toUpperCase();
          if(r === curType) curLen++;
          else break;
        }
      } else {
        curType = null; curLen = 0;
      }

      out.push({name:m.name, curType, curLen, bestW, bestL});
    }
    return out;
  }

  function renderStreaks(){
    const s = computeStreaks();
    if(!s.length){
      $("streakBody").innerHTML = "No members yet.";
      return;
    }
  }
  function renderGroupMultiTracker(){
    const el = document.getElementById("groupMultiBody");
    if(!el) return;

    const rows = (STATE.groupLegs || []).map(r => ({
      WeekID: (r.WeekID || "").trim(),
      Date: (r.Date || "").trim(),
      Round: String(r.Round || "").trim(),
      Owner: (r.Owner || "").trim(),
      Leg: (r.Leg || "").trim(),
      Result: (r.Result || "").trim().toUpperCase(),
      Notes: (r.Notes || "").trim(),
    })).filter(r => r.WeekID && r.Owner && r.Leg);

    if(!rows.length){
      el.textContent = "No group multi legs logged yet.";
      return;
    }

    const withDates = rows.map(r => ({...r, _d: normalizeDate(r.Date)}));
    withDates.sort((a,b) => ((b._d?.getTime() ?? 0) - (a._d?.getTime() ?? 0)) || (b.WeekID.localeCompare(a.WeekID)));
    const latestWeek = withDates[0].WeekID;

    const weekRows = withDates.filter(r => r.WeekID === latestWeek);

    const total = weekRows.length;
    const w = weekRows.filter(r => r.Result === "W").length;
    const l = weekRows.filter(r => r.Result === "L").length;
    const v = weekRows.filter(r => r.Result === "V").length;
    const p = weekRows.filter(r => r.Result === "P" || r.Result === "").length;

    const round = weekRows[0]?.Round || "‚Äî";
    const date = weekRows[0]?.Date || "‚Äî";

    const sold = weekRows.filter(r => r.Result === "L").map(r => r.Owner);
    const soldLine = sold.length
      ? `<div><b>Sold it:</b> <span class="bad">${sold.map(escapeHtml).join(", ")}</span></div>`
      : `<div><b>Sold it:</b> ‚Äî</div>`;

    const legsHtml = weekRows.map(r => {
      const cls =
        r.Result === "W" ? "good" :
        r.Result === "L" ? "bad" :
        r.Result === "P" ? "warn" : "";

      const res = r.Result || "P";

      return `<div>‚Ä¢ <b>${escapeHtml(r.Owner)}</b>: ${escapeHtml(r.Leg)} ‚Äî <span class="${cls}">${escapeHtml(res)}</span></div>`;
    }).join("");

    el.innerHTML = `
      <div><b>Latest:</b> ${escapeHtml(latestWeek)} ¬∑ Date ${escapeHtml(date)} ¬∑ Round ${escapeHtml(round)}</div>
      <div><b>Status:</b> <span class="good">${w}W</span> / <span class="bad">${l}L</span> / <span class="small">${v}V</span> / <span class="warn">${p}P</span> (Total ${total})</div>
      ${soldLine}
      <div style="height:8px"></div>
      <div><b>Legs:</b></div>
      ${legsHtml}
    `;
  }

    // show top current hot and cold
    const hot = s.filter(x => x.curType==="W").sort((a,b)=>b.curLen-a.curLen)[0];
    const cold = s.filter(x => x.curType==="L").sort((a,b)=>b.curLen-a.curLen)[0];

    const rows = s
      .sort((a,b)=> (b.bestW - a.bestW) || (a.bestL - b.bestL))
      .map(x => {
        const cur = x.curType ? `${x.curType==="W" ? "üî•" : "üßä"} ${x.curType}√ó${x.curLen}` : "‚Äî";
        return `<div><b>${escapeHtml(x.name)}:</b> current ${cur} ¬∑ best üî• W√ó${x.bestW} ¬∑ worst üßä L√ó${x.bestL}</div>`;
      })
      .join("");

    $("streakBody").innerHTML = `
      <div><b>Hottest right now:</b> ${hot ? `${escapeHtml(hot.name)} üî• W√ó${hot.curLen}` : "‚Äî"}</div>
      <div><b>Coldest right now:</b> ${cold ? `${escapeHtml(cold.name)} üßä L√ó${cold.curLen}` : "‚Äî"}</div>
      <div style="height:8px"></div>
      ${rows}
    `;
  }

  function renderRoundCallouts(){
    const round = $("roundSelect").value;
    if(round === "ALL"){
      $("roundCallouts").innerHTML = "Select a specific round to see winner / wooden spoon.";
      return;
    }

    const roundBets = STATE.bets
      .filter(b => String(b.Round||"").trim() === round)
      .filter(b => ["W","L","V"].includes((b.Result||"").toUpperCase())); // exclude pending

    if(!roundBets.length){
      $("roundCallouts").innerHTML = `No settled bets for Round ${escapeHtml(round)} yet.`;
      return;
    }

    const by = new Map();
    for(const m of STATE.members) by.set(m.name, 0);

    for(const b of roundBets){
      const name = (b.Name||"").trim();
      if(!by.has(name)) continue;
      by.set(name, by.get(name) + profitForBet(b));
    }

    const arr = Array.from(by.entries()).map(([name,profit])=>({name,profit}));
    arr.sort((a,b)=>b.profit-a.profit);

    const winner = arr[0];
    const spoon = arr[arr.length-1];

    const wCls = winner.profit>0 ? "good" : winner.profit<0 ? "bad" : "";
    const sCls = spoon.profit<0 ? "bad" : spoon.profit>0 ? "good" : "";

    $("roundCallouts").innerHTML = `
      <div><b>Round ${escapeHtml(round)} Winner:</b> <span class="${wCls} mono">${escapeHtml(winner.name)} ${fmtMoney(winner.profit, STATE.currency)}</span></div>
      <div><b>Wooden Spoon:</b> <span class="${sCls} mono">${escapeHtml(spoon.name)} ${fmtMoney(spoon.profit, STATE.currency)}</span></div>
      <div class="small" style="margin-top:8px">Round totals use settled bets only (W/L/V). Pending futures don‚Äôt count.</div>
    `;
  }

  function openProfile(name){
    const row = STATE.leaderboard.find(x => x.name === name);
    const mem = STATE.members.find(m => m.name === name);
    const nick = mem?.nickname ? ` (${mem.nickname})` : "";
    if(!row) return;

    $("profileTitle").textContent = name + nick + " ‚Äî Profile";
    $("profileSub").textContent = `Settled stake: ${fmtMoney(row.settledStake, STATE.currency)} ¬∑ Pending stake: ${fmtMoney(row.pendingStake, STATE.currency)} ¬∑ Returned: ${fmtMoney(row.returned, STATE.currency)}`;

    $("pProfit").textContent = fmtMoney(row.profit, STATE.currency);
    $("pProfit").className = "value mono " + (row.profit>0 ? "good" : row.profit<0 ? "bad" : "");
    $("pROI").textContent = fmtPct(row.roi);
    $("pROI").className = "value mono " + (row.roi>0 ? "good" : row.roi<0 ? "bad" : "");
    $("pWin").textContent = fmtPct(row.winrate);
    $("pBets").textContent = String(row.bets);

    // bets table + chart data
    const bets = STATE.bets
      .filter(b => (b.Name||"").trim() === name)
      .filter(b => ["W","L","V"].includes((b.Result||"").toUpperCase()))
      .sort((a,b)=> (normalizeDate(a.Date)?.getTime() ?? 0) - (normalizeDate(b.Date)?.getTime() ?? 0));

    const tb = $("profileBetsBody");
    tb.innerHTML = "";
    if(!bets.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="small">No settled bets yet.</td>`;
      tb.appendChild(tr);
    } else {
      for(const b of bets.slice().reverse().slice(0, 50)){ // last 50
        const res = (b.Result||"").toUpperCase();
        const odds = toNum(b.Odds);
        const stake = toNum(b.Stake);
        const p = profitForBet(b);
        const pCls = p>0 ? "good" : p<0 ? "bad" : "";
        const resCls = res==="W" ? "statusW" : res==="L" ? "statusL" : "statusV";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(b.Date||"")}</td>
          <td class="mono">${escapeHtml(String(b.Round||""))}</td>
          <td>${escapeHtml(b.Match||"")}</td>
          <td>${escapeHtml(b.Market||"")}</td>
          <td class="right mono">${odds ? odds.toFixed(2) : "‚Äî"}</td>
          <td class="right mono">${fmtMoney(stake, STATE.currency)}</td>
          <td class="right mono ${resCls}">${escapeHtml(res)}</td>
          <td class="right mono ${pCls}">${fmtMoney(p, STATE.currency)}</td>
        `;
        tb.appendChild(tr);
      }
    }

    drawProfitChart(bets);

    $("modalBg").style.display = "flex";
  }

  function drawProfitChart(betsChrono){
    const canvas = $("profitChart");
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;

    // Clear
    ctx.clearRect(0,0,w,h);

    // data points: cumulative profit
    let cum = 0;
    const pts = betsChrono.map((b, i) => {
      cum += profitForBet(b);
      return {x:i, y:cum};
    });

    // If no data, draw placeholder
    if(pts.length < 2){
      ctx.font = "14px system-ui";
      ctx.fillStyle = getComputedStyle(document.body).color;
      ctx.globalAlpha = 0.7;
      ctx.fillText("Not enough settled bets yet to chart.", 20, 40);
      ctx.globalAlpha = 1;
      return;
    }

    const ys = pts.map(p=>p.y);
    const minY = Math.min(...ys, 0);
    const maxY = Math.max(...ys, 0);
    const pad = 30;

    const xScale = (i) => pad + (i/(pts.length-1))*(w-2*pad);
    const yScale = (v) => {
      const span = (maxY - minY) || 1;
      return (h-pad) - ((v - minY)/span)*(h-2*pad);
    };

    // axes
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue("--line");
    ctx.lineWidth = 1;
    ctx.beginPath();
    // y=0 line
    const y0 = yScale(0);
    ctx.moveTo(pad, y0);
    ctx.lineTo(w-pad, y0);
    ctx.stroke();

    // line
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue("--accent");
    ctx.lineWidth = 2;
    ctx.beginPath();
    pts.forEach((p, i) => {
      const x = xScale(p.x), y = yScale(p.y);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // end label
    const last = pts[pts.length-1];
    const lastX = xScale(last.x), lastY = yScale(last.y);
    ctx.fillStyle = getComputedStyle(document.body).color;
    ctx.font = "12px system-ui";
    ctx.globalAlpha = 0.9;
    ctx.fillText(`Final: ${fmtMoney(last.y, STATE.currency)}`, Math.min(lastX+8, w-160), Math.max(lastY-8, 16));
    ctx.globalAlpha = 1;
  }

  function initTheme(){
    const saved = localStorage.getItem("puntclub_theme");
    if(saved) document.documentElement.setAttribute("data-theme", saved);
  }
  function toggleTheme(){
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    const next = cur === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", next);
    localStorage.setItem("puntclub_theme", next);
    // If modal chart open, redraw
  }

  function validateHeaders(betRows){
    const required = ["Date","Round","Name","Match","Market","Odds","Stake","Result","Return","BetType","Notes"];
    const missing = required.filter(c => !(c in (betRows[0] || {})));
    if(missing.length){
      setError(`Heads up: your <b>Bets</b> CSV is missing columns: <b>${missing.join(", ")}</b>. The site will still load, but some features may be wrong until headers match.`);
    }
  }

  async function loadAll(){
    setError("");
    document.body.classList.add("loading");
    try{
      const [cfgRows, memberRows, contribRows, betRows, groupLegRows] = await Promise.all([
        fetchCSV(CSV.config),
        fetchCSV(CSV.members),
        fetchCSV(CSV.contributions),
        fetchCSV(CSV.bets),
        fetchCSV(CSV.grouplegs),
      ]);

      STATE.config = readConfig(cfgRows);
      STATE.members = activeMembers(memberRows);
      STATE.contributions = contribRows;
      STATE.bets = betRows;
      STATE.groupLegs = groupLegRows;

      validateHeaders(betRows);

      applyConfig();
      buildRoundOptions();
      buildPersonFilter();

      STATE.leaderboard = computeLeaderboard();

      const totals = computeClubTotals(STATE.leaderboard);
      const bank = computeBank();

      renderOverview(totals);
      renderLeaderboard(STATE.leaderboard);
      renderBank(bank);
      renderFutures();

      renderHallOfFame();
      renderStreaks();
      renderGroupMultiTracker();

      renderRoundView();
      renderRecent();

      const lu = computeLastUpdated();
      $("lastUpdated").textContent = "Last updated: " + (lu ? lu.toLocaleString() : "‚Äî");
    } catch(e){
      console.error(e);
      setError(`Couldn‚Äôt load your sheet data. Common causes: the sheet isn‚Äôt published, the tab names changed, or ‚Äúanyone with link‚Äù isn‚Äôt set to viewer.<br><br><b>Error:</b> ${escapeHtml(e.message)}`);
      $("clubSub").textContent = "Fix sheet publishing or links, then hit Refresh.";
    } finally {
      document.body.classList.remove("loading");
    }
  }

  // Events
  $("themeBtn").addEventListener("click", () => { toggleTheme(); renderRecent(); renderRoundView(); });
  $("refreshBtn").addEventListener("click", loadAll);
  $("sortBy").addEventListener("change", () => renderLeaderboard(STATE.leaderboard.slice()));
  $("roundSelect").addEventListener("change", () => { renderRoundView(); });
  $("personFilter").addEventListener("change", () => { renderRoundView(); renderRecent(); });
  $("typeFilter").addEventListener("change", () => { renderRoundView(); renderRecent(); });
  $("resultFilter").addEventListener("change", () => { renderRoundView(); renderRecent(); });
  $("searchBox").addEventListener("input", () => { renderRoundView(); renderRecent(); });

  // modal close
  $("closeModal").addEventListener("click", () => $("modalBg").style.display = "none");
  $("modalBg").addEventListener("click", (e) => { if(e.target === $("modalBg")) $("modalBg").style.display = "none"; });

  // Boot
  initTheme();
  loadAll();
</script>
</body>
</html>

